name: coverage
on:
  push:
    branches:
      - v2
  pull_request:
    branches:
      - v2

jobs:
  report:
    runs-on: 'ubuntu-latest'
    name: report
    steps:
      - uses: actions/checkout@master
      - name: Setup go
        uses: actions/setup-go@master
        with:
          go-version: 1.16
      - name: Run tests with coverage
        run: go test -covermode=atomic -coverprofile=coverage.out ./...
      - name: Compute coverage by func
        run: go tool cover -func=coverage.out -o coverage-funcs.txt
      - name: Generate HTML report
        run: go tool cover -html=coverage.out -o coverage.html
      - name: Archive funcs coverage
        uses: actions/upload-artifact@v2
        with:
          name: coverage-funcs
          path: coverage-funcs.txt
      - name: Archive report
        uses: actions/upload-artifact@v2
        with:
          name: coverage.html
          path: coverage.html
